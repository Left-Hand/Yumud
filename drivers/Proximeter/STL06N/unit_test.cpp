#include "stl06n.hpp"

using namespace ymd::drivers::stl06n;

namespace {
[[maybe_unused]] static void test_crc(){
    constexpr uint8_t bytes[] = {
        0x54, 0x2C, 0x68, 0x08, 0xAB, 0x7E, 0xE0, 0x00,
        0xE4, 0xDC, 0x00, 0xE2, 0xD9, 0x00, 0xE5, 0xD5,
        0x00, 0xE3, 0xD3, 0x00, 0xE4, 0xD0, 0x00, 0xE9,
        0xCD, 0x00, 0xE4, 0xCA, 0x00, 0xE2, 0xC7, 0x00,
        0xE9, 0xC5, 0x00, 0xE5, 0xC2, 0x00, 0xE5, 0xC0,
        0x00, 0xE5, 0xBE, 0x82, 0x3A, 0x1A
    };

    constexpr auto actual_crc = [&]() -> uint8_t{
        Crc8Calculator calc = Crc8Calculator();
        return calc.push_bytes(std::span(bytes)).get();
    }();
    static_assert(actual_crc == 0x50);
}

[[maybe_unused]] static void test_crc2(){
    constexpr uint8_t bytes[] = {
        0x54, 0x2c, 0xfe, 0xd, 0x79, 0x21, 0x55, 0x02, 0x14, 0x55, 0x02, 0x14,
        0x57, 0x02, 0x14, 0x6a, 0x02, 0x14, 0xe4, 0x02, 0x5c, 0xe0, 0x02, 0x2c,
        0xe0, 0x02, 0x1e, 0xe3, 0x02, 0x38, 0x25, 0x00, 0x60, 0x27, 0x00, 0x14,
        0x2b, 0x00, 0x14, 0x30, 0x00, 0x13, 0xa6, 0x24, 0x97, 0x5a
    };

    constexpr auto actual_crc = [&]() -> uint8_t{
        Crc8Calculator calc = Crc8Calculator();
        return calc.push_bytes(std::span(bytes)).get();
    }();
    static_assert(actual_crc == 0xBC);
}



static_assert(__builtin_offsetof(LidarSectorPacket, LidarSectorPacket::spin_speed_code) == 0);
static_assert(__builtin_offsetof(LidarSectorPacket, LidarSectorPacket::start_angle_code) == 2);
static_assert(__builtin_offsetof(LidarSectorPacket, LidarSectorPacket::packed_cluster) == 4);
static_assert(__builtin_offsetof(LidarSectorPacket, LidarSectorPacket::stop_angle_code) == 40);
static_assert(__builtin_offsetof(LidarSectorPacket, LidarSectorPacket::timestamp) == 42);
static_assert(__builtin_offsetof(LidarSectorPacket, LidarSectorPacket::crc8) == 44);


}
